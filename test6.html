<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with Markers and Lines</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div id="map" style="height: 400px;"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var map = L.map('map').setView([37.9838, 23.7275], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            var markersLayers = {};
            markersLayers["lines"] = L.layerGroup();

            // Assuming linesLayer is a layer group for lines
            var linesLayer = L.layerGroup().addTo(map);

            fetch('/server/map_admin/map.php')
                .then(response => response.json())
                .then(data => {

                    data.features.forEach(feature => {
                        const category = feature.properties.category;

                        if (!markersLayers[category]) {
                            markersLayers[category] = L.layerGroup();
                        }

                        const customMarkers = L.marker([feature.geometry.coordinates[0], feature.geometry.coordinates[1]], {
                            icon: getCategoryIcon(category),
                            draggable: category === "Base" || category === "Truck Active",
                        });

                        if (category === "Truck Active") {
                            var line = L.polyline([
                                [feature.geometry.coordinates[0], feature.geometry.coordinates[1]],
                                [someInitialLat, someInitialLng] // Set initial coordinates for the line
                            ], {
                                color: 'blue',
                                dashArray: '5, 10'
                            }).addTo(linesLayer);

                            customMarkers.on('drag', function (event) {
                                const marker = event.target;
                                const position = marker.getLatLng();

                                // Update the line coordinates dynamically
                                line.setLatLngs([
                                    [position.lat, position.lng],
                                    [someInitialLat, someInitialLng]
                                ]);

                                // Also update your data if needed
                                feature.geometry.coordinates[0] = position.lat;
                                feature.geometry.coordinates[1] = position.lng;
                            });

                            // Store the line in a property of the marker
                            customMarkers.line = line;
                        }

                        markersLayers[category].addLayer(customMarkers);
                        markersLayers[category].addTo(map);

                    });

                    L.control.layers(null, {
                        'Markers': markersLayers,
                        'Lines': linesLayer
                    }).addTo(map);

                })
                .catch(error => console.error('Error:', error));

            // Function to get the appropriate icon based on category
            function getCategoryIcon(category) {
                // Your existing icon logic goes here
            }
        });
    </script>
</body>
</html>
